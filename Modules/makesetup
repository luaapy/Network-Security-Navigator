#!/bin/sh
# NSN (Network Security Navigator)
# makesetup - Generate Makefile fragments and module initialization code
# from the Modules/Setup configuration file.

SETUP_FILE=${1:-Modules/Setup}
OUT_MAKEFILE="Modules/Setup.config"
OUT_CFILE="Modules/builtin_modules.c"

if [ ! -f "$SETUP_FILE" ]; then
    echo "Error: $SETUP_FILE not found"
    exit 1
fi

echo "/* Automatically generated by Modules/makesetup */" > "$OUT_CFILE"
echo "#include \"nsn.h\"" >> "$OUT_CFILE"
echo "" >> "$OUT_CFILE"

echo "# Automatically generated by Modules/makesetup from $SETUP_FILE" > "$OUT_MAKEFILE"
echo "MODOBJS =" >> "$OUT_MAKEFILE"
echo "MODLIBS =" >> "$OUT_MAKEFILE"
echo "" >> "$OUT_MAKEFILE"

# First pass: External declarations for init functions
grep -v '^#' "$SETUP_FILE" | grep -v '^[[:space:]]*$' | while read mod srcs flags; do
    echo "extern void _nsn_init_${mod}(void);" >> "$OUT_CFILE"
done

echo "" >> "$OUT_CFILE"
echo "struct _nsn_builtin_module {" >> "$OUT_CFILE"
echo "    const char *name;" >> "$OUT_CFILE"
echo "    void (*init_func)(void);" >> "$OUT_CFILE"
echo "} _nsn_builtins[] = {" >> "$OUT_CFILE"

# Second pass: Table entries and Makefile rules
grep -v '^#' "$SETUP_FILE" | grep -v '^[[:space:]]*$' | while read mod srcs flags; do
    # Add to C table
    echo "    {\"$mod\", _nsn_init_${mod}}," >> "$OUT_CFILE"
    
    # Add to Makefile objects
    for src in $srcs; do
        obj=$(echo "$src" | sed 's/\.c$/.o/')
        echo "MODOBJS += Modules/$obj" >> "$OUT_MAKEFILE"
    done
    
    # Add to Makefile libs
    if [ ! -z "$flags" ]; then
        echo "MODLIBS += $flags" >> "$OUT_MAKEFILE"
    fi
done

echo "    {NULL, NULL}" >> "$OUT_CFILE"
echo "};" >> "$OUT_CFILE"
echo "" >> "$OUT_CFILE"
echo "void Nsn_InitBuiltinModules(void) {" >> "$OUT_CFILE"
echo "    for (int i = 0; _nsn_builtins[i].name != NULL; i++) {" >> "$OUT_CFILE"
echo "        _nsn_builtins[i].init_func();" >> "$OUT_CFILE"
echo "    }" >> "$OUT_CFILE"
echo "}" >> "$OUT_CFILE"

echo "Generated $OUT_MAKEFILE and $OUT_CFILE"
chmod +x Modules/makesetup 2>/dev/null
